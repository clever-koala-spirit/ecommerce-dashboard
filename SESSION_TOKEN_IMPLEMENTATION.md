# Shopify App Bridge Session Token Authentication Implementation

## Overview

The Slay Season app now uses **Shopify App Bridge session token authentication** for embedded app deployments, as required by Shopify as of January 2025. This replaces cookie-based authentication with secure JWT tokens generated by the Shopify Admin frontend.

### Key Benefits
- **Secure**: JWT tokens signed by Shopify, verified using `SHOPIFY_API_SECRET`
- **Embedded-ready**: Works seamlessly when app is loaded inside Shopify admin iframe
- **Backward compatible**: Falls back gracefully to `X-Shop-Domain` header for standalone mode
- **Token expiration**: Tokens expire in ~1 minute, automatically refreshed by App Bridge

---

## Architecture

### Frontend Flow (Client)
1. App Bridge CDN script loads: `https://cdn.shopify.com/shopifycloud/app-bridge.js`
2. When embedded in Shopify admin, `window.shopify` API is available
3. For every API request, frontend calls `window.shopify.idToken()` to get a fresh JWT
4. JWT is sent in `Authorization: Bearer <token>` header
5. Falls back to `X-Shop-Domain` header if not embedded

### Backend Flow (Server)
1. Session token middleware (`verifySessionToken`) intercepts all requests
2. Extracts Bearer token from Authorization header
3. Verifies JWT signature using `SHOPIFY_API_SECRET` and `HS256` algorithm
4. Validates:
   - Token audience (`aud`) matches `SHOPIFY_API_KEY`
   - Token is not expired (`exp` time)
   - Token format is valid
5. Extracts shop domain from JWT `dest` field (e.g., `https://store.myshopify.com/admin`)
6. Sets `req.shopDomain` for downstream middleware
7. Falls back to `X-Shop-Domain` header if token verification fails (standalone mode)

### JWT Token Structure
```javascript
{
  "iss": "https://example-store.myshopify.com",      // Issuer (shop domain)
  "dest": "https://example-store.myshopify.com/admin", // Destination
  "aud": "YOUR_SHOPIFY_API_KEY",                      // Audience (app's API key)
  "sub": "12345",                                      // Subject (user ID)
  "exp": 1705363200,                                   // Expiration (Unix timestamp, ~1 min from now)
  "nbf": 1705363140,                                   // Not before time
  "iat": 1705363140                                    // Issued at time
}
```

---

## Implementation Details

### 1. Client-Side Changes

#### `/client/index.html`
- Added Shopify App Bridge CDN script:
```html
<script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
```

#### `/client/src/providers/ShopifyProvider.jsx`
- Updated `authenticatedFetch()` to fetch session tokens:
  ```javascript
  if (embedded && window.shopify) {
    try {
      token = await window.shopify.idToken();
    } catch (err) {
      console.warn('[ShopifyProvider] Failed to get session token:', err.message);
    }
  }
  ```
- Includes token in `Authorization: Bearer <token>` header
- Updated `checkAuth()` to verify session tokens during auth check
- Maintains backward compatibility with `X-Shop-Domain` header

#### `/client/src/services/api.js`
- Updated `apiFetch()` helper to get and include session tokens
- All API calls now attempt to fetch session token from App Bridge
- Falls back gracefully if token fetch fails (not embedded or error)

### 2. Server-Side Changes

#### `/server/middleware/sessionToken.js` (NEW)
- Exports `verifySessionToken` middleware
- Extracts `Bearer <token>` from Authorization header
- Verifies JWT signature using:
  - Secret: `SHOPIFY_API_SECRET`
  - Algorithm: `HS256`
  - Options: validates `aud`, `exp`, token structure
- Sets `req.shopDomain` from JWT's `dest` field
- Sets `req.sessionTokenPayload` with full JWT payload
- Sets `req.authMethod = 'session_token'` to track auth method
- Logs verification status and errors
- Falls through gracefully to next middleware if token invalid/absent

#### `/server/middleware/security.js` (UPDATED)
- Imported `verifySessionToken` from sessionToken.js
- Exported `verifySessionToken` from security.js for use in index.js
- Updated `requireShopAuth` to work with both:
  - Session tokens (sets `req.shopDomain` before this middleware runs)
  - X-Shop-Domain header (checked if `req.shopDomain` not already set)

#### `/server/index.js` (UPDATED)
- Added `verifySessionToken` import
- Placed `verifySessionToken` middleware early in the chain:
  - After JSON body parser (needs parsed request)
  - Before protected API routes
  - This allows token verification to happen globally, setting `req.shopDomain`

---

## Authentication Flow

### For Embedded Apps (Inside Shopify Admin)

```
Frontend (React)                          Backend (Express)
     |                                          |
     |-- Check if embedded: window.top !== window.self
     |
     |-- Call window.shopify.idToken() ----\
     |                                      |
     |<-- JWT token ←----- Shopify App Bridge
     |
     |-- Send request with Authorization: Bearer <token>
     |-------------------------------------------------> verifySessionToken middleware
     |                                                  |
     |                                                  |-- Extract token from header
     |                                                  |-- Verify JWT signature
     |                                                  |-- Validate aud, exp
     |                                                  |-- Extract shop domain from dest
     |                                                  |-- Set req.shopDomain
     |                                                  |
     |<-- 200 OK with authenticated response <-----------|
     |
```

### For Standalone Mode (Development/Deployed)

```
Frontend (React)                          Backend (Express)
     |                                          |
     |-- Check if embedded: false (window.self === window.top)
     |
     |-- Store shop domain in sessionStorage
     |
     |-- Send request with X-Shop-Domain: store.myshopify.com
     |-------------------------------------------------> verifySessionToken middleware
     |                                                  |
     |                                                  |-- No Bearer token, fall through
     |                                                  |
     |                                      requireShopAuth middleware
     |                                                  |
     |                                                  |-- Extract shopDomain from header
     |                                                  |-- Look up shop in database
     |                                                  |-- Validate shop is active
     |                                                  |
     |<-- 200 OK with authenticated response <-----------|
     |
```

---

## Environment Variables

Ensure these are set in your `.env` file:

```bash
# Shopify App Configuration
SHOPIFY_API_KEY=your_api_key_here
SHOPIFY_API_SECRET=your_api_secret_here

# Database and Other Configs (existing)
ENCRYPTION_KEY=your_encryption_key
DATABASE_URL=your_db_url
# ... other env vars
```

The `SHOPIFY_API_SECRET` is used as the signing key to verify session tokens.

---

## Security Considerations

1. **Token Verification**: JWTs are cryptographically signed by Shopify using `SHOPIFY_API_SECRET`
2. **Audience Validation**: Token's `aud` claim is verified against `SHOPIFY_API_KEY`
3. **Expiration Validation**: Tokens are short-lived (~1 minute) and verified against `exp` claim
4. **Shop Domain Extraction**: Shop domain is extracted from the `dest` claim, not user input
5. **Graceful Fallback**: If token verification fails, auth falls back to header-based validation
6. **No Cookie Storage**: Session tokens are JWTs, not stored in cookies—prevents CSRF attacks

---

## Testing

### Test Session Token Flow (Embedded)
1. Deploy app to Shopify Partner account
2. Install app in development store
3. Open app in Shopify admin
4. Check browser Network tab for API requests
5. Verify `Authorization: Bearer <token>` header is present on API calls
6. Check server logs for `[SessionToken] Verified for shop: <domain>`

### Test Fallback Flow (Standalone)
1. Run app locally: `npm run dev` (server) + `npm run dev` (client)
2. Visit `http://localhost:3000` (or Vite dev URL)
3. Manually enter shop domain to test
4. Verify `X-Shop-Domain` header is used instead
5. Check server logs for standard auth flow (not session token)

### Test Error Cases
1. Invalid token signature: Token verification should fail and fall through
2. Expired token: Should be rejected with `TOKEN_EXPIRED` error
3. Wrong audience: Should be rejected with `INVALID_AUDIENCE` error
4. Malformed Authorization header: Should fall through to header-based auth

---

## File Changes Summary

| File | Changes |
|------|---------|
| `client/index.html` | Added Shopify App Bridge CDN script |
| `client/src/providers/ShopifyProvider.jsx` | Added session token fetching to `authenticatedFetch` and `checkAuth` |
| `client/src/services/api.js` | Added session token fetching to `apiFetch` helper |
| `server/middleware/sessionToken.js` | NEW: JWT verification middleware |
| `server/middleware/security.js` | Imported and exported `verifySessionToken` |
| `server/index.js` | Added `verifySessionToken` to middleware chain |

---

## Troubleshooting

### "Invalid token audience" Error
- **Cause**: JWT's `aud` claim doesn't match `SHOPIFY_API_KEY`
- **Fix**: Verify `SHOPIFY_API_KEY` environment variable is correct

### "Token expired" Error
- **Cause**: Token was generated >1 minute ago
- **Fix**: App Bridge automatically refreshes tokens; this shouldn't happen in normal use
- **Debug**: Check if `window.shopify.idToken()` is being called repeatedly

### "Failed to get session token" Warning
- **Cause**: App is not embedded or App Bridge failed to load
- **Fix**: Normal for standalone mode; app falls back to header-based auth
- **Debug**: Check if `window.shopify` is defined in embedded context

### 401 Authentication Required
- **Cause**: Shop not found in database or not active
- **Fix**: Ensure shop is installed and `isActive` is true in database
- **Debug**: Check `requireShopAuth` middleware logs and database

### CORS Issues
- **Cause**: Request origin not in allowed list
- **Fix**: CORS config allows Shopify domains; verify `getCorsConfig()` in security.js
- **Debug**: Check browser console for CORS errors and server logs

---

## References

- [Shopify App Bridge Documentation](https://shopify.dev/docs/api/app-bridge)
- [Shopify Session Token Guide](https://shopify.dev/docs/api/admin-rest/2024-01/resources/oauth)
- [JWT.io - JWT Verification](https://jwt.io)
- [Node.js jsonwebtoken Package](https://github.com/auth0/node-jsonwebtoken)

---

## Next Steps

1. ✅ Implement session token middleware
2. ✅ Update frontend to fetch and send tokens
3. ✅ Test embedded app flow in Shopify Partner account
4. ✅ Test standalone mode locally
5. Deploy to production with session token auth enabled
6. Monitor error logs for any token verification issues
7. Update Shopify app configuration if needed

---

**Last Updated**: February 13, 2026
**Status**: Implementation Complete
